<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Comparably</title>

    <link rel="stylesheet" href="bower_components/normalize-css/normalize.css" />
    <link rel="stylesheet" href="src/base.css" />

    <link href='http://fonts.googleapis.com/css?family=Lobster' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Patua+One' rel='stylesheet' type='text/css'>

    <link rel="import" href="src/components/fixed-header.html" />
    <link rel="import" href="src/components/user-login.html" />

    <link rel="import" href="src/components/lozenge-list.html" />

    <link rel="import" href="src/components/comparison-lozenge.html" />
    <link rel="import" href="src/components/add-lozenge.html" />

    <link rel="import" href="src/components/item-facet.html" />
    <link rel="import" href="src/components/add-facet.html" />
</head>
<body>
    <fixed-header>
        <h1>Comparably</h1>

        <user-login class="header-right" data-bind="event: { 'login': login, 'logout': logout }">
        </user-login>
    </fixed-header>

    <lozenge-list style="display: none" data-bind="visible: true">
        <!-- ko with: $data.comparison -->
            <!-- ko foreach: items -->
                <comparison-lozenge>
                    <lozenge-banner data-bind="editableText: name"></lozenge-banner>
                    <!-- ko foreach: facets -->
                        <item-facet data-bind="twoWayAttr: { score: score },
                                               editableText: description">
                        </item-facet>
                    <!-- /ko -->

                    <add-facet data-bind="event: { 'add-facet': addFacet }"></add-facet>
                </comparison-lozenge>
            <!-- /ko -->

            <add-lozenge data-bind="event: { 'add-item': addItem }"></add-lozenge>
        <!-- /ko -->

        <!-- ko with: !$data.comparison() && $data.user() -->
            <comparison-lozenge>
                <lozenge-banner>Comparisons</lozenge-banner>
                <!-- ko foreach: comparisons() -->
                    <item-facet data-bind="text: name, click: $root.loadComparison"></item-facet>
                <!-- /ko -->
            </comparison-lozenge>
        <!-- /ko -->
    </lozenge-list>


    <script src="bower_components/knockout/dist/knockout.debug.js"></script>
    <script src="bower_components/knockout-mapping/knockout.mapping.js"></script>

    <script src="src/knockout-bindings/editable-binding.js"></script>
    <script src="src/knockout-bindings/twoWayAttr-binding.js"></script>

    <script src="src/ItemViewModel.js"></script>
    <script src="src/ComparisonViewModel.js"></script>
    <script src="src/UserViewModel.js"></script>

    <script src="src/comparisonQuery.js"></script>

    <script>
        (function () {
            var viewModel = {
                comparison: ko.observable(),
                user: ko.observable(new GuestUserViewModel()),

                loadComparison: function (comparison) {
                    window.location.hash = "#" + comparison.id;
                },

                login: function (_, event) {
                    viewModel.user(new UserViewModel(event.detail));
                },
                logout: function () {
                    viewModel.user(new GuestUserViewModel());
                }
            };

            ko.applyBindings(viewModel, document.querySelector("body"));

            function loadUserComparisons(userId) {
                comparisonQuery.loadUserComparisons(userId, function (err, comparisons) {
                    if (err) {
                        alert(err);
                    } else {
                        viewModel.myComparisons(comparisons);
                    }
                });
            }

            function onHashChange() {
                var hash = window.location.hash.substring(1);
                var comparisonId = parseInt(hash, 10);

                if (comparisonId) {
                    comparisonQuery.loadComparison(comparisonId, function (err, comparisonData) {
                        if (err) {
                            alert("Error loading comparison data");
                        } else if (comparisonData === null) {
                            alert("Comparison does not exist");
                        } else {
                            viewModel.comparison(new ComparisonViewModel(comparisonData));
                        }
                    });
                } else {
                    viewModel.comparison(null);
                }
            }

            window.addEventListener("hashchange", onHashChange);
            onHashChange();
        })();
    </script>
</body>
</html>
